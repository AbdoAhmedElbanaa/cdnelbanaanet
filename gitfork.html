<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة Fork لمستودعات GitHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f4f8;
        }
        .step-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease-in-out;
        }
        .step-card.disabled {
             opacity: 0.5;
             pointer-events: none;
        }
        .step-card:hover:not(.disabled) {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .step-number {
            background-color: #3b82f6;
            color: white;
            border-radius: 9999px;
            width: 2.5rem;
            height: 2.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 py-10">
    <div class="container mx-auto p-4 max-w-4xl">
                <!-- Header -->
        <div class="text-center mb-8 relative">
            <div class="absolute top-0 right-0" id="lang-switcher-container">
                <button id="lang-switcher" class="px-4 py-2 bg-white text-gray-800 rounded-lg hover:bg-gray-200 transition-colors font-semibold shadow">EN</button>
            </div>
            <h1 id="main-title" class="text-4xl font-bold text-gray-800">أداة Fork لمستودعات GitHub</h1>
            <p id="main-description" class="text-gray-500 mt-2">قم بعمل Fork لجميع مستودعات مؤسسة أو مستخدم دفعة واحدة.</p>
        </div>

        <!-- Step 1: Authentication -->
        <div class="step-card">
            <div class="flex items-center gap-4 mb-4">
                <span class="step-number">1</span>
                <h2 id="step1-title" class="text-2xl font-bold text-gray-700">المصادقة</h2>
            </div>
            <p id="step1-desc" class="text-gray-600 mb-3"></p>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="password" id="patInput" class="flex-grow p-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ghp_...">
                <button id="savePatBtn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all">
                    <span id="save-pat-btn-text">حفظ التوكن</span>
                </button>
            </div>
             <p id="pat-status" class="text-green-600 mt-2 h-5"></p>
        </div>

        <!-- Step 2: Fetch Repos -->
        <div id="step2" class="step-card disabled">
             <div class="flex items-center gap-4 mb-4">
                <span class="step-number">2</span>
                <h2 id="step2-title" class="text-2xl font-bold text-gray-700">جلب المستودعات</h2>
            </div>
            <p id="step2-desc" class="text-gray-600 mb-3"></p>
            
            <!-- NEW: Radio buttons for source type -->
            <div class="mb-4">
                <label id="step2-type-label" class="block text-sm font-medium text-gray-700 mb-2"></label>
                <div class="flex gap-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="repoType" value="org" class="h-5 w-5 text-blue-600" checked>
                        <span id="step2-type-org" class="mx-2 text-gray-700"></span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="repoType" value="user" class="h-5 w-5 text-blue-600">
                        <span id="step2-type-user" class="mx-2 text-gray-700"></span>
                    </label>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-2">
                 <input type="text" id="sourceUrlInput" class="flex-grow p-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="">
                 <button id="fetchReposBtn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all">
                    <span id="fetch-repos-btn-text">جلب</span>
                 </button>
            </div>
            <div id="repo-list-container" class="mt-4 hidden">
                 <h3 id="repo-list-title" class="text-lg font-semibold mb-2"></h3>
                 <!-- Repo list will be populated with checkboxes here -->
                 <div id="repo-list" class="bg-gray-50 p-4 rounded-lg border max-h-60 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Step 3: Select Target -->
        <div id="step3" class="step-card disabled">
            <div class="flex items-center gap-4 mb-4">
                <span class="step-number">3</span>
                <h2 id="step3-title" class="text-2xl font-bold text-gray-700">تحديد وجهة الـ Fork</h2>
            </div>
            <p id="step3-desc" class="text-gray-600 mb-3"></p>
            <div class="flex flex-col sm:flex-row gap-2">
                <select id="targetOrgSelect" class="flex-grow p-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                <button id="fetchOrgsBtn" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all">
                    <span id="fetch-orgs-btn-text"></span>
                </button>
            </div>
        </div>

        <!-- Step 4: Fork Repos -->
        <div id="step4" class="step-card disabled">
            <div class="flex items-center gap-4 mb-4">
                <span class="step-number">4</span>
                <h2 id="step4-title" class="text-2xl font-bold text-gray-700">تنفيذ Fork</h2>
            </div>
            <p id="step4-desc" class="text-gray-600 mb-3"></p>
            <p id="rate-limit-warning" class="text-sm text-yellow-700 bg-yellow-100 p-3 rounded-lg mb-4"></p>
            <div class="flex flex-col sm:flex-row gap-2">
                <button id="forkAllBtn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all disabled:bg-gray-400">
                    <span id="fork-all-btn-text"></span>
                </button>
                <button id="stopForkBtn" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 transition-all hidden">
                    <span id="stop-fork-btn-text"></span>
                </button>
            </div>
             <div id="fork-progress" class="mt-4 hidden bg-gray-50 p-4 rounded-lg border max-h-60 overflow-y-auto"></div>
        </div>

        <!-- Loader & Error -->
        <div id="loader" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 loader"></div>
        <div id="error-message" class="hidden text-center p-4 bg-red-100 text-red-700 rounded-lg mt-4"></div>
    </div>

    <script>
    // --- STATE ---
    let pat = '';
    let repos = [];
    let isForkingCancelled = false;
    let currentLang = 'ar';

    // --- ELEMENTS ---
    const patInput = document.getElementById('patInput');
    const savePatBtn = document.getElementById('savePatBtn');
    const sourceUrlInput = document.getElementById('sourceUrlInput'); // Renamed from orgUrlInput
    const fetchReposBtn = document.getElementById('fetchReposBtn');
    const fetchOrgsBtn = document.getElementById('fetchOrgsBtn');
    const targetOrgSelect = document.getElementById('targetOrgSelect');
    const forkAllBtn = document.getElementById('forkAllBtn');
    const stopForkBtn = document.getElementById('stopForkBtn');
    const langSwitcher = document.getElementById('lang-switcher');
    
    // UI feedback elements
    const patStatus = document.getElementById('pat-status');
    const loader = document.getElementById('loader');
    const errorMessage = document.getElementById('error-message');
    const repoListContainer = document.getElementById('repo-list-container');
    const repoListDiv = document.getElementById('repo-list');
    const forkProgressDiv = document.getElementById('fork-progress');

    // --- TRANSLATIONS ---
    const translations = {
        ar: {
            title: "أداة Fork لمستودعات GitHub",
            description: "قم بعمل Fork لجميع مستودعات مؤسسة أو مستخدم دفعة واحدة.",
            step1Title: "المصادقة",
            step1Desc: `للوصول لبياناتك وعمل Fork، تحتاج الأداة لصلاحيات. يرجى إنشاء <a href="https://github.com/settings/tokens/new?scopes=public_repo,read:org" target="_blank" class="text-blue-600 hover:underline">Personal Access Token (Classic)</a> مع تفعيل صلاحيات <code>public_repo</code> (لعمل Fork) و <code>read:org</code> (لقراءة المؤسسات) ثم قم بلصقه أدناه.`,
            savePatBtn: "حفظ التوكن",
            patSaved: "تم حفظ التوكن بنجاح!",
            patMissing: "الرجاء إدخال التوكن أولاً.",
            step2Title: "جلب المستودعات",
            step2Desc: "اختر نوع المصدر (مؤسسة أو مستخدم) وأدخل الرابط الخاص بصفحة المستودعات.",
            step2InputPlaceholder: "https://github.com/YourNameOrOrg",
            step2TypeLabel: "نوع المصدر:",
            step2TypeOrg: "مؤسسة",
            step2TypeUser: "مستخدم",
            fetchReposBtn: "جلب",
            fetchingRepos: "جاري جلب المستودعات...",
            repoListTitle: "قائمة المستودعات:",
            selectAll: "تحديد الكل",
            step3Title: "تحديد وجهة الـ Fork",
            step3Desc: "اختر أين تريد عمل Fork للمستودعات. يمكنك الاختيار بين حسابك الشخصي أو أي مؤسسة أنت عضو فيها.",
            fetchOrgsBtn: "جلب مؤسساتي",
            fetchingOrgs: "جاري الجلب...",
            personalAccount: "حسابي الشخصي",
            step4Title: "تنفيذ Fork",
            step4Desc: "حدد المستودعات التي تريدها في الخطوة 2، ثم اضغط على الزر أدناه لبدء العملية.",
            rateLimitWarning: "تنبيه: لتجنب تجاوز حدود استخدام واجهة GitHub، يوجد تأخير بسيط بين كل عملية Fork. قد تستغرق العملية وقتاً طويلاً إذا كان عدد المستودعات كبيراً.",
            forkAllBtn: "عمل Fork للمحدد ({count})",
            forking: "جاري التنفيذ...",
            stopForkBtn: "إيقاف",
            stopping: "جاري الإيقاف...",
            forkProgressTitle: "تقدم العملية:",
            forkSuccess: "نجاح: {repo}",
            forkFail: "فشل: {repo} - {error}",
            forkCancelled: "تم إلغاء العملية من قبل المستخدم.",
            forkComplete: "اكتملت العملية!",
            invalidUrl: "الرابط غير صالح. أدخل رابط مستخدم أو مؤسسة صحيح (مثل: https://github.com/username).",
            noRepoSelected: "الرجاء تحديد مستودع واحد على الأقل لعمل Fork.",
            langButton: "EN"
        },
        en: {
            title: "GitHub Bulk Fork Tool",
            description: "Fork all repositories from an organization or user at once.",
            step1Title: "Authentication",
            step1Desc: `To access your data and perform forks, the tool needs permissions. Please create a <a href="https://github.com/settings/tokens/new?scopes=public_repo,read:org" target="_blank" class="text-blue-600 hover:underline">Personal Access Token (Classic)</a> with <code>public_repo</code> (for forking) and <code>read:org</code> (for reading orgs) scopes enabled, then paste it below.`,
            savePatBtn: "Save Token",
            patSaved: "Token saved successfully!",
            patMissing: "Please enter your token first.",
            step2Title: "Fetch Repositories",
            step2Desc: "Select the source type (Organization or User) and enter the URL for their repositories page.",
            step2InputPlaceholder: "https://github.com/YourNameOrOrg",
            step2TypeLabel: "Source Type:",
            step2TypeOrg: "Organization",
            step2TypeUser: "User",
            fetchReposBtn: "Fetch",
            fetchingRepos: "Fetching repositories...",
            repoListTitle: "Repository List:",
            selectAll: "Select All",
            step3Title: "Select Fork Destination",
            step3Desc: "Choose where you want to fork the repositories. You can select your personal account or any organization you are a member of.",
            fetchOrgsBtn: "Fetch My Orgs",
            fetchingOrgs: "Fetching...",
            personalAccount: "Personal Account",
            step4Title: "Fork Repositories",
            step4Desc: "Select the repositories you want in Step 2, then click the button below to start.",
            rateLimitWarning: "Warning: To avoid hitting GitHub's API rate limits, there is a delay between each fork operation. This process may take a long time for a large number of repositories.",
            forkAllBtn: "Fork Selected ({count})",
            forking: "Forking...",
            stopForkBtn: "Stop",
            stopping: "Stopping...",
            forkProgressTitle: "Forking Progress:",
            forkSuccess: "Success: {repo}",
            forkFail: "Fail: {repo} - {error}",
            forkCancelled: "Operation cancelled by user.",
            forkComplete: "Forking process completed!",
            invalidUrl: "Invalid URL. Please enter a valid user or organization URL (e.g., https://github.com/username).",
            noRepoSelected: "Please select at least one repository to fork.",
            langButton: "ع"
        }
    };

    // --- FUNCTIONS ---
    function setLanguage(lang) {
        currentLang = lang;
        const t = translations[lang];
        const isRTL = lang === 'ar';

        document.documentElement.lang = lang;
        document.documentElement.dir = isRTL ? 'rtl' : 'ltr';

        document.title = t.title;
        document.getElementById('main-title').textContent = t.title;
        document.getElementById('main-description').textContent = t.description;
        document.getElementById('step1-title').textContent = t.step1Title;
        document.getElementById('step1-desc').innerHTML = t.step1Desc;
        document.getElementById('save-pat-btn-text').textContent = t.savePatBtn;
        document.getElementById('step2-title').textContent = t.step2Title;
        document.getElementById('step2-desc').textContent = t.step2Desc;
        document.getElementById('sourceUrlInput').placeholder = t.step2InputPlaceholder;
        document.getElementById('step2-type-label').textContent = t.step2TypeLabel;
        document.getElementById('step2-type-org').textContent = t.step2TypeOrg;
        document.getElementById('step2-type-user').textContent = t.step2TypeUser;
        document.getElementById('fetch-repos-btn-text').textContent = t.fetchReposBtn;
        document.getElementById('repo-list-title').textContent = t.repoListTitle;
        document.getElementById('step3-title').textContent = t.step3Title;
        document.getElementById('step3-desc').textContent = t.step3Desc;
        document.getElementById('fetch-orgs-btn-text').textContent = t.fetchOrgsBtn;
        document.getElementById('step4-title').textContent = t.step4Title;
        document.getElementById('step4-desc').textContent = t.step4Desc;
        document.getElementById('rate-limit-warning').textContent = t.rateLimitWarning;
        // Set initial count to 0
        document.getElementById('fork-all-btn-text').textContent = t.forkAllBtn.replace('{count}', 0);
        document.getElementById('stop-fork-btn-text').textContent = t.stopForkBtn;
        langSwitcher.textContent = t.langButton;
        
        const langSwitcherContainer = document.getElementById('lang-switcher-container');
        langSwitcherContainer.classList.toggle('right-0', isRTL);
        langSwitcherContainer.classList.toggle('left-0', !isRTL);

        localStorage.setItem('preferredLang', lang);
        
        // Refresh org list with translation
        populateOrgsDropdown([]);
    }

    function setLoading(isLoading) {
        loader.classList.toggle('hidden', !isLoading);
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
    }

    function clearError() {
        errorMessage.classList.add('hidden');
    }

    function updateUIState() {
        if (pat) {
            document.getElementById('step2').classList.remove('disabled');
            document.getElementById('step3').classList.remove('disabled');
        }
        if (repos.length > 0) {
            document.getElementById('step4').classList.remove('disabled');
            // Button text is now handled by updateForkButtonCount()
        }
    }

    // NEW Function: Updates the fork button count and disabled state
    function updateForkButtonCount() {
        const selectedCount = document.querySelectorAll('.repo-checkbox:checked').length;
        const forkBtnText = document.getElementById('fork-all-btn-text');
        const t = translations[currentLang];
        
        if (forkBtnText) {
             forkBtnText.textContent = t.forkAllBtn.replace('{count}', selectedCount);
        }
       
        forkAllBtn.disabled = (selectedCount === 0);
    }

    async function getPaginatedData(url) {
        let results = [];
        let nextUrl = url;
        while (nextUrl) {
            const response = await fetch(nextUrl, {
                headers: { 'Authorization': `token ${pat}` }
            });
            if (!response.ok) throw new Error(`GitHub API Error: ${response.statusText}`);
            
            results = results.concat(await response.json());
            
            const linkHeader = response.headers.get('Link');
            const nextLink = linkHeader?.split(',').find(s => s.includes('rel="next"'));
            nextUrl = nextLink ? nextLink.match(/<([^>]+)>/)[1] : null;
        }
        return results;
    }

    function populateOrgsDropdown(orgs) {
        targetOrgSelect.innerHTML = `<option value="">${translations[currentLang].personalAccount}</option>`;
        orgs.forEach(org => {
            targetOrgSelect.innerHTML += `<option value="${org.login}">${org.login}</option>`;
        });
    }

    // --- EVENT LISTENERS ---
    savePatBtn.addEventListener('click', () => {
        clearError();
        const patValue = patInput.value.trim();
        if (patValue) {
            pat = patValue;
            patStatus.textContent = translations[currentLang].patSaved;
            patInput.classList.add('border-green-500');
            updateUIState();
        } else {
            showError(translations[currentLang].patMissing);
        }
    });

    fetchReposBtn.addEventListener('click', async () => {
        clearError();
        
        const url = sourceUrlInput.value.trim();
        // Updated regex to capture name from org or user URL
        const match = url.match(/github\.com\/(?:orgs\/)?([^/?]+)/);
        
        if (!match || match[1] === 'orgs') {
            showError(translations[currentLang].invalidUrl);
            return;
        }
        
        const name = match[1];
        const repoType = document.querySelector('input[name="repoType"]:checked').value;
        const apiEndpoint = (repoType === 'org') ? 'orgs' : 'users';
        
        const apiUrl = `https://api.github.com/${apiEndpoint}/${name}/repos?type=public&per_page=100`;

        setLoading(true);
        fetchReposBtn.disabled = true;
        document.getElementById('fetch-repos-btn-text').textContent = translations[currentLang].fetchingRepos;
        
        try {
            repos = await getPaginatedData(apiUrl);
            
            // --- MODIFIED: Populate list with checkboxes ---
            const selectAllHtml = `
                <div class="mb-2 border-b pb-2">
                    <label class="flex items-center cursor-pointer p-2 hover:bg-gray-100 rounded">
                        <input type="checkbox" id="select-all-checkbox" class="h-5 w-5 text-blue-600 border-gray-300 rounded">
                        <span id="select-all-label" class="mx-2 font-medium">${translations[currentLang].selectAll}</span>
                    </label>
                </div>
            `;
            
            repoListDiv.innerHTML = selectAllHtml + repos.map(repo => `
                <label class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer">
                    <input type="checkbox" class="repo-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded" data-name="${repo.name}">
                    <span class="mx-2 text-gray-800">${repo.name}</span>
                </label>
            `).join('');
            
            repoListContainer.classList.remove('hidden');
            
            // Add listener for 'Select All'
            document.getElementById('select-all-checkbox').addEventListener('click', (e) => {
                document.querySelectorAll('.repo-checkbox').forEach(cb => {
                    cb.checked = e.target.checked;
                });
                updateForkButtonCount(); // Update count
            });
            
            // Add listeners for individual checkboxes
            document.querySelectorAll('.repo-checkbox').forEach(cb => {
                cb.addEventListener('click', () => {
                    // If one is unchecked, uncheck "Select All"
                    if (!cb.checked) {
                        document.getElementById('select-all-checkbox').checked = false;
                    }
                    updateForkButtonCount(); // Update count
                });
            });
            // --- END MODIFICATION ---

            updateUIState();
            updateForkButtonCount(); // Set initial count (0) and disable button
        } catch (error) {
            showError(error.message);
        } finally {
            setLoading(false);
            fetchReposBtn.disabled = false;
            document.getElementById('fetch-repos-btn-text').textContent = translations[currentLang].fetchReposBtn;
        }
    });

    fetchOrgsBtn.addEventListener('click', async () => {
        clearError();
        const apiUrl = 'https://api.github.com/user/orgs';
        
        setLoading(true);
        fetchOrgsBtn.disabled = true;
        document.getElementById('fetch-orgs-btn-text').textContent = translations[currentLang].fetchingOrgs;

        try {
            const orgs = await getPaginatedData(apiUrl);
            populateOrgsDropdown(orgs);
        } catch(error) {
            showError(error.message);
        } finally {
            setLoading(false);
            fetchOrgsBtn.disabled = false;
            document.getElementById('fetch-orgs-btn-text').textContent = translations[currentLang].fetchOrgsBtn;
        }
    });

    forkAllBtn.addEventListener('click', async () => {
        isForkingCancelled = false;
        clearError();

        // --- MODIFIED: Get selected repos only ---
        const selectedRepoNames = Array.from(document.querySelectorAll('.repo-checkbox:checked'))
                                         .map(cb => cb.dataset.name);
        
        const reposToFork = repos.filter(repo => selectedRepoNames.includes(repo.name));

        if (reposToFork.length === 0) {
            showError(translations[currentLang].noRepoSelected);
            return;
        }
        // --- END MODIFICATION ---

        forkProgressDiv.innerHTML = `<strong>${translations[currentLang].forkProgressTitle}</strong>`;
        forkProgressDiv.classList.remove('hidden');
        forkAllBtn.classList.add('hidden');
        stopForkBtn.classList.remove('hidden');
        
        let counter = 0;
        const targetOrg = targetOrgSelect.value;
        const bodyPayload = targetOrg ? { organization: targetOrg } : {};

        // --- MODIFIED: Loop over reposToFork ---
        for (const repo of reposToFork) {
            if (isForkingCancelled) {
                forkProgressDiv.innerHTML += `<strong class="mt-2 block text-yellow-700">${translations[currentLang].forkCancelled}</strong>`;
                break;
            }
            counter++;
            // Update progress text to use the length of the selected list
            const progressText = `(${counter}/${reposToFork.length}) ${repo.name}`;
            try {
                const response = await fetch(`https://api.github.com/repos/${repo.owner.login}/${repo.name}/forks`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `token ${pat}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bodyPayload)
                });

                const result = await response.json();
                if (!response.ok || response.status > 299) {
                     throw new Error(result.message || response.statusText);
                }
                
                forkProgressDiv.innerHTML += `<div class="text-green-600">${translations[currentLang].forkSuccess.replace('{repo}', progressText)}</div>`;

            } catch (error) {
                forkProgressDiv.innerHTML += `<div class="text-red-600">${translations[currentLang].forkFail.replace('{repo}', progressText).replace('{error}', error.message)}</div>`;
            }
            // Scroll to bottom of progress div
            forkProgressDiv.scrollTop = forkProgressDiv.scrollHeight;
            // Increased delay to avoid rate limiting
            await new Promise(res => setTimeout(res, 1500));
        }
        // --- END MODIFICATION ---
        
        if (!isForkingCancelled) {
             forkProgressDiv.innerHTML += `<strong class="mt-2 block">${translations[currentLang].forkComplete}</strong>`;
        }

        stopForkBtn.classList.add('hidden');
        forkAllBtn.classList.remove('hidden');
        updateForkButtonCount(); // Reset button state
    });

    stopForkBtn.addEventListener('click', () => {
        isForkingCancelled = true;
        document.getElementById('stop-fork-btn-text').textContent = translations[currentLang].stopping;
        stopForkBtn.disabled = true;
    });

    langSwitcher.addEventListener('click', () => {
        const newLang = currentLang === 'ar' ? 'en' : 'ar';
        setLanguage(newLang);
    });
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const savedLang = localStorage.getItem('preferredLang') || 'ar';
        setLanguage(savedLang);
        updateForkButtonCount(); // Set initial button state on load
    });

    </script>
</body>

</html>
