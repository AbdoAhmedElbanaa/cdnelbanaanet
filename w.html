<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UUTL Weather - Gemini Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href='https://cdn.elbana.net/arfontmi.css' rel='stylesheet'/>
    
    <style>
        /* --- UUTL Design System Styles --- */
        body { font-family: 'MiSans Arabic', sans-serif; transition: background-image 0.8s ease-in-out; }
        
        /* Core Animations */
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scale-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes glow { 0%, 100% { text-shadow: 0 0 10px rgba(255,255,255,0.3); } 50% { text-shadow: 0 0 25px rgba(255,255,255,0.6); } }

        .anim-float { animation: float 5s ease-in-out infinite; }
        .anim-fade { animation: fade-in 0.5s ease-out forwards; }
        .anim-scale { animation: scale-in 0.3s ease-out forwards; }
        .anim-glow { animation: glow 3s infinite; }

        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glass Effect */
        .glass-container {
            background: rgba(18, 18, 25, 0.65);
            backdrop-filter: blur(40px) saturate(160%);
            -webkit-backdrop-filter: blur(40px) saturate(160%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.7), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .glass-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.01);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-item:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.3);
        }

        /* Active State */
        .active-state {
            background: rgba(59, 130, 246, 0.35) !important;
            border: 1px solid rgba(147, 197, 253, 0.6) !important;
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.3);
            transform: scale(1.05);
        }

        /* Modal Styles */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }

        .ai-typing::after {
            content: '...';
            animation: typing 1.5s infinite;
        }
        @keyframes typing { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }

        /* Custom Tooltip Style */
        #glass-tooltip {
            position: fixed;
            z-index: 1000;
            padding: 8px 12px;
            background: rgba(20, 20, 30, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: #fff;
            font-size: 11px;
            font-weight: 500;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s ease, transform 0.2s ease;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            max-width: 200px;
            text-align: center;
            line-height: 1.4;
        }
        #glass-tooltip.show {
            opacity: 1;
            transform: scale(1);
        }

        /* Badge for "Now" */
        .now-badge {
            font-size: 10px;
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 99px;
            margin-bottom: 2px;
        }

        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        #more-days { max-height: 0; overflow: hidden; transition: max-height 0.7s ease, opacity 0.5s ease; opacity: 0; }
        #more-days.open { max-height: 1200px; opacity: 1; }
    </style>
</head>

<body id="dynamic-bg" class="min-h-screen bg-cover bg-center flex items-center justify-center p-4 bg-gray-900">

    <div class="absolute inset-0 bg-black/30 z-0"></div>
    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/20 z-0"></div>

    <!-- Custom Glass Tooltip Element -->
    <div id="glass-tooltip"></div>

    <div class="glass-container w-full max-w-[500px] rounded-[32px] overflow-hidden text-white relative z-10 h-[90vh] flex flex-col">
        
        <!-- Loading Screen -->
        <div id="loading" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-zinc-900/90 backdrop-blur-xl transition-opacity duration-500">
            <div class="w-12 h-12 border-[3px] border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p id="loading-text" class="mt-4 text-sm font-light text-blue-200 animate-pulse">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>
        </div>

        <!-- AI Modal Popup -->
        <div id="ai-modal" class="absolute inset-0 z-[60] flex items-center justify-center p-4 hidden modal-backdrop opacity-0 transition-opacity duration-300">
            <div class="glass-container w-full max-w-sm rounded-3xl p-6 relative transform scale-95 transition-transform duration-300" id="ai-modal-content">
                
                <button onclick="closeAiModal()" class="absolute top-4 left-4 p-2 bg-white/5 hover:bg-white/10 rounded-full transition-colors" data-tooltip="ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©">
                    <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>

                <div class="flex flex-col items-center text-center">
                    <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mb-4 border border-blue-400/30 shadow-[0_0_20px_rgba(59,130,246,0.3)]">
                        <img id="ai-modal-icon" src="https://cdn.jsdelivr.net/gh/basmilius/weather-icons/production/fill/all/star.svg" class="w-10 h-10 drop-shadow-md">
                    </div>
                    
                    <h3 id="ai-modal-title" class="text-xl font-bold text-white mb-1">--</h3>
                    <div id="ai-modal-value" class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-white mb-6">--</div>

                    <div id="ai-loading-state" class="flex flex-col items-center py-4">
                        <div class="w-8 h-8 border-2 border-blue-400 border-t-transparent rounded-full animate-spin mb-3"></div>
                        <p class="text-sm text-blue-200 ai-typing">Gemini ŸäŸÇŸàŸÖ ÿ®ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</p>
                    </div>

                    <div id="ai-result-state" class="hidden w-full text-right bg-white/5 rounded-xl p-4 border border-white/10 max-h-[200px] overflow-y-auto custom-scroll">
                        <p id="ai-response-text" class="text-sm leading-relaxed text-gray-100 font-light"></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="weather-content" class="opacity-0 transition-opacity duration-700 h-full overflow-y-auto custom-scroll relative">
            
            <!-- Header -->
            <div class="sticky top-0 z-30 bg-black/20 backdrop-blur-md border-b border-white/5 px-6 py-4 pb-2 flex justify-col items-center flex-col">
                <div class="flex justify-between items-center w-full mb-2">
                    <div>
                        <div class="flex items-center gap-2" data-tooltip="ŸÖŸàŸÇÿπŸÉ ÿßŸÑÿ≠ÿßŸÑŸä">
                            <svg class="w-4 h-4 text-red-400 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                            <h2 id="location-text" class="text-lg font-bold tracking-wide text-white drop-shadow-md leading-tight">--</h2>
                        </div>
                        <p id="view-mode" class="text-[10px] text-blue-300 mt-1 mr-6 tracking-wide">ŸÖÿ®ÿßÿ¥ÿ±</p>
                    </div>
                    <button onclick="getLocation()" class="group bg-white/5 hover:bg-white/10 p-2 rounded-full border border-white/10 transition-colors" data-tooltip="ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ">
                        <svg class="w-5 h-5 text-blue-400 group-hover:rotate-180 transition-transform duration-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                </div>

                <!-- AI Tip Banner -->
                <div id="ai-tip-container" class="w-full bg-blue-500/10 border border-blue-400/20 rounded-xl p-2 flex items-center justify-center gap-2 cursor-help transition-transform hover:scale-[1.01]" data-tooltip="ŸÜÿµŸäÿ≠ÿ© ÿ∞ŸÉŸäÿ© ÿ™ÿ™ÿ∫Ÿäÿ± ÿ≠ÿ≥ÿ® ÿßŸÑÿ∑ŸÇÿ≥">
                    <span class="text-lg animate-pulse">üí°</span>
                    <p id="ai-tip-text" class="text-xs text-blue-100 font-medium text-center line-clamp-1">ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ŸÑÿßŸÖ ŸÜÿµŸäÿ≠ÿ© ÿßŸÑÿ∑ŸÇÿ≥...</p>
                </div>
            </div>

            <!-- Hero Section -->
            <div id="hero-section" class="flex flex-col items-center pt-4 pb-6 relative transition-all duration-500">
                <div class="text-center mb-4">
                    <div id="main-title" class="text-6xl font-black tracking-wider text-transparent bg-clip-text bg-gradient-to-b from-white via-white to-blue-200 anim-glow" style="font-feature-settings: 'tnum' on;" data-tooltip="ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ÿßŸÑŸä">--:--</div>
                    <div id="sub-title" class="text-sm font-medium text-blue-100/80 mt-1 px-4 py-1 rounded-full bg-white/5 border border-white/5 inline-block backdrop-blur-sm" data-tooltip="ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸäŸàŸÖ">--</div>
                    <div id="selected-time-indicator" class="text-[10px] text-yellow-300 mt-2 font-bold opacity-0 transition-opacity">ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿßÿπÿ©: --</div>
                </div>

                <div class="w-36 h-36 relative z-10 anim-float filter drop-shadow-[0_15px_30px_rgba(0,0,0,0.5)]" data-tooltip="ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÇÿ≥ ÿßŸÑÿ≠ÿßŸÑŸäÿ©">
                    <img id="main-icon-img" src="" alt="Weather" class="w-full h-full object-contain">
                </div>
                
                <div class="flex items-baseline justify-center gap-2 mt-[-15px] z-20">
                    <h1 id="current-temp" class="text-8xl font-bold tracking-tighter text-white drop-shadow-lg leading-none" data-tooltip="ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©">--¬∞</h1>
                    <span id="min-temp-display" class="text-3xl text-white/50 font-light tracking-wide" data-tooltip="ÿßŸÑÿµÿ∫ÿ±Ÿâ ÿßŸÑŸÖÿ™ŸàŸÇÿπÿ©">--¬∞</span>
                </div>
                
                <div class="inline-flex items-center gap-2 bg-white/5 px-4 py-1.5 rounded-full border border-white/10 mt-2 backdrop-blur-sm shadow-sm" data-tooltip="ŸàÿµŸÅ ÿßŸÑÿ≠ÿßŸÑÿ©">
                    <span id="weather-desc" class="text-sm font-medium text-blue-50">--</span>
                </div>
            </div>

            <!-- Horizontal Scroll -->
            <div class="px-5 mb-2 transition-all duration-500 delay-100 anim-fade">
                <h3 id="hourly-title" class="text-[10px] font-bold text-white/40 mb-3 uppercase tracking-widest px-1">ÿÆŸÑÿßŸÑ ÿßŸÑŸäŸàŸÖ</h3>
                <div id="hourly-container" class="flex overflow-x-auto gap-3 pb-4 hide-scroll cursor-grab select-none p-2"></div>
            </div>

            <!-- Grid Details Section (Clickable for AI) -->
            <div class="px-5 pb-6">
                <h3 class="text-[10px] font-bold text-white/40 mb-3 uppercase tracking-widest px-1">ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ŸÅÿßÿµŸäŸÑ ŸàÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ</h3>
                <div class="grid grid-cols-3 gap-2.5">
                    
                    <div onclick="openAiAnalysis('apparent_temp')" class="glass-item rounded-2xl p-3 flex flex-col items-center text-center cursor-pointer group hover:border-blue-400/50" data-tooltip="ÿßŸÜŸÇÿ± ŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ¥ÿπŸàÿ± ÿßŸÑÿ≠ŸÇŸäŸÇŸä">
                        <img src="https://cdn.jsdelivr.net/gh/basmilius/weather-icons/production/fill/all/thermometer.svg" class="w-6 h-6 mb-1 opacity-90 group-hover:scale-110 transition-transform">
                        <span class="text-[9px] text-gray-400">ÿßŸÑÿ¥ÿπŸàÿ±</span>
                        <span id="app-temp-val" class="text-base font-bold text-white">--</span>
                        <span id="app-temp-status" class="text-[10px] text-blue-200 mt-0.5">--</span>
                    </div>

                    <div onclick="openAiAnalysis('humidity')" class="glass-item rounded-2xl p-3 flex flex-col items-center text-center cursor-pointer group hover:border-blue-400/50" data-tooltip="ÿßŸÜŸÇÿ± ŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ±ÿ∑Ÿàÿ®ÿ©">
                        <img src="https://cdn.jsdelivr.net/gh/basmilius/weather-icons/production/fill/all/humidity.svg" class="w-6 h-6 mb-1 opacity-90 group-hover:scale-110 transition-transform">
                        <span class="text-[9px] text-gray-400">ÿßŸÑÿ±ÿ∑Ÿàÿ®ÿ©</span>
                        <span id="humidity-val" class="text-base font-bold text-white">--</span>
                        <span id="humidity-status" class="text-[10px] text-blue-200 mt-0.5">--</span>
                    </div>

                    <div onclick="openAiAnalysis('wind')" class="glass-item rounded-2xl p-3 flex flex-col items-center text-center cursor-pointer group hover:border-blue-400/50" data-tooltip="ÿßŸÜŸÇÿ± ŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ±Ÿäÿßÿ≠">
                        <img src="https://cdn.jsdelivr.net/gh/basmilius/weather-icons/production/fill/all/wind.svg" class="w-6 h-6 mb-1 opacity-90 group-hover:scale-110 transition-transform">
                        <span class="text-[9px] text-gray-400">ÿßŸÑÿ±Ÿäÿßÿ≠</span>
                        <span id="wind-val" class="text-base font-bold text-white">--</span>
                        <span id="wind-status" class="text-[10px] text-blue-200 mt-0.5">--</span>
                    </div>

                    <div onclick="openAiAnalysis('pressure')" class="glass-item rounded-2xl p-3 flex flex-col items-center text-center cursor-pointer group hover:border-blue-400/50" data-tooltip="ÿßŸÜŸÇÿ± ŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ∂ÿ∫ÿ∑">
                        <img src="https://cdn.jsdelivr.net/gh/basmilius/weather-icons/production/fill/all/barometer.svg" class="w-6 h-6 mb-1 opacity-90 group-hover:scale-110 transition-transform">
                        <span class="text-[9px] text-gray-400">ÿßŸÑÿ∂ÿ∫ÿ∑</span>
                        <span id="press-val" class="text-base font-bold text-white">--</span>
                        <span id="press-status" class="text-[10px] text-blue-200 mt-0.5">--</span>
                    </div>

                    <div onclick="openAiAnalysis('clouds')" class="glass-item rounded-2xl p-3 flex flex-col items-center text-center cursor-pointer group hover:border-blue-400/50" data-tooltip="ÿßŸÜŸÇÿ± ŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ≥ÿ≠ÿ®">
                        <img src="https://cdn.jsdelivr.net/gh/basmilius/weather-icons/production/fill/all/overcast.svg" class="w-6 h-6 mb-1 opacity-90 group-hover:scale-110 transition-transform">
                        <span class="text-[9px] text-gray-400">ÿßŸÑÿ∫ŸäŸàŸÖ</span>
                        <span id="cloud-val" class="text-base font-bold text-white">--</span>
                        <span id="cloud-status" class="text-[10px] text-blue-200 mt-0.5">--</span>
                    </div>

                    <div onclick="openAiAnalysis('uv')" class="glass-item rounded-2xl p-3 flex flex-col items-center text-center cursor-pointer group hover:border-blue-400/50" data-tooltip="ÿßŸÜŸÇÿ± ŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ£ÿ¥ÿπÿ©">
                        <img src="https://cdn.jsdelivr.net/gh/basmilius/weather-icons/production/fill/all/uv-index.svg" class="w-6 h-6 mb-1 opacity-90 group-hover:scale-110 transition-transform">
                        <span class="text-[9px] text-gray-400">UV</span>
                        <span id="uv-val" class="text-base font-bold text-white">--</span>
                        <span id="uv-status" class="text-[10px] text-blue-200 mt-0.5">--</span>
                    </div>

                    <div onclick="openAiAnalysis('visibility')" class="glass-item rounded-2xl p-3 flex flex-col items-center text-center cursor-pointer group hover:border-blue-400/50" data-tooltip="ÿßŸÜŸÇÿ± ŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ±ÿ§Ÿäÿ©">
                        <img src="https://cdn.jsdelivr.net/gh/basmilius/weather-icons/production/fill/all/mist.svg" class="w-6 h-6 mb-1 opacity-90 group-hover:scale-110 transition-transform">
                        <span class="text-[9px] text-gray-400">ÿßŸÑÿ±ÿ§Ÿäÿ©</span>
                        <span id="vis-val" class="text-base font-bold text-white">--</span>
                        <span id="vis-status" class="text-[10px] text-blue-200 mt-0.5">--</span>
                    </div>

                    <div class="glass-item rounded-2xl p-3 flex flex-col items-center text-center" data-tooltip="ŸÖŸàÿπÿØ ÿ¥ÿ±ŸàŸÇ ÿßŸÑÿ¥ŸÖÿ≥">
                        <img src="https://cdn.jsdelivr.net/gh/basmilius/weather-icons/production/fill/all/sunrise.svg" class="w-6 h-6 mb-1 opacity-90">
                        <span class="text-[9px] text-gray-400">ÿßŸÑÿ¥ÿ±ŸàŸÇ</span>
                        <span id="sunrise-val" class="text-base font-bold text-white">--</span>
                        <span class="text-[10px] text-blue-200 mt-0.5">ÿµÿ®ÿßÿ≠ÿßŸã</span>
                    </div>

                    <div class="glass-item rounded-2xl p-3 flex flex-col items-center text-center" data-tooltip="ŸÖŸàÿπÿØ ÿ∫ÿ±Ÿàÿ® ÿßŸÑÿ¥ŸÖÿ≥">
                        <img src="https://cdn.jsdelivr.net/gh/basmilius/weather-icons/production/fill/all/sunset.svg" class="w-6 h-6 mb-1 opacity-90">
                        <span class="text-[9px] text-gray-400">ÿßŸÑÿ∫ÿ±Ÿàÿ®</span>
                        <span id="sunset-val" class="text-base font-bold text-white">--</span>
                        <span class="text-[10px] text-blue-200 mt-0.5">ŸÖÿ≥ÿßÿ°Ÿã</span>
                    </div>
                </div>
            </div>

            <!-- Bottom List -->
            <div class="bg-black/30 px-5 py-6 rounded-t-[32px] border-t border-white/5 backdrop-blur-md">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xs font-bold text-white flex items-center gap-2 opacity-90">
                        <svg class="w-5 h-5" viewBox="0 0 36 36"><path fill="#e0e7ec" d="M36 32a4 4 0 0 1-4 4H4a4 4 0 0 1-4-4V9a4 4 0 0 1 4-4h28a4 4 0 0 1 4 4z"/><path fill="#66757f" d="M23.657 19.12H17.87c-1.22 0-1.673-.791-1.673-1.56c0-.791.429-1.56 1.673-1.56h8.184c1.154 0 1.628 1.04 1.628 1.628c0 .452-.249.927-.52 1.492l-5.607 11.395c-.633 1.266-.882 1.717-1.899 1.717c-1.244 0-1.877-.949-1.877-1.605c0-.271.068-.474.226-.791zM10.889 19h-.5c-1.085 0-1.538-.731-1.538-1.5c0-.792.565-1.5 1.538-1.5h2.015c.972 0 1.515.701 1.515 1.605V30.47c0 1.13-.558 1.763-1.53 1.763s-1.5-.633-1.5-1.763z"/><path fill="#dd2f45" d="M34 0h-3.277c.172.295.277.634.277 1a2 2 0 0 1-4 0c0-.366.105-.705.277-1H8.723C8.895.295 9 .634 9 1a2 2 0 0 1-4 0c0-.366.105-.705.277-1H2a2 2 0 0 0-2 2v11h36V2a2 2 0 0 0-2-2"/><path fill="#f5f8fa" d="M13.182 4.604c0-.5.32-.78.75-.78c.429 0 .749.28.749.78v5.017h1.779c.51 0 .73.38.72.72a.7.7 0 0 1-.72.659h-2.498c-.49 0-.78-.319-.78-.819zm-6.91 0c0-.5.32-.78.75-.78s.75.28.75.78v3.488c0 .92.589 1.649 1.539 1.649c.909 0 1.529-.769 1.529-1.649V4.604c0-.5.319-.78.749-.78s.75.28.75.78v3.568c0 1.679-1.38 2.949-3.028 2.949c-1.669 0-3.039-1.25-3.039-2.949zM5.49 9.001c0 1.679-1.069 2.119-1.979 2.119c-.689 0-1.839-.27-1.839-1.14c0-.269.23-.609.56-.609c.4 0 .75.37 1.199.37c.56 0 .56-.52.56-.84V4.604c0-.5.32-.78.749-.78c.431 0 .75.28.75.78z"/><path fill="#f4abba" d="M32 10a1 1 0 1 0 2 0a1 1 0 0 0-2 0m0-3a1 1 0 1 0 2 0a1 1 0 0 0-2 0m-3 3a1 1 0 1 0 2 0a1 1 0 0 0-2 0m0-3a1 1 0 1 0 2 0a1 1 0 0 0-2 0m-3 3a1 1 0 1 0 2 0a1 1 0 0 0-2 0m0-3a1 1 0 1 0 2 0a1 1 0 0 0-2 0m-3 0a1 1 0 1 0 2 0a1 1 0 0 0-2 0m0 3a1 1 0 1 0 2 0a1 1 0 0 0-2 0"/></svg>
                        ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑŸäŸàŸÖ ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
                    </h3>
                </div>
                
                <div id="forecast-list" class="flex flex-col gap-2.5"></div>
                <div id="more-days" class="flex flex-col gap-2.5 mt-2.5"></div>

                <button id="toggle-btn" class="w-full mt-4 py-3 text-xs font-bold text-white/70 bg-white/5 hover:bg-white/10 hover:text-white rounded-xl transition-all border border-white/5 flex items-center justify-center gap-2 group" data-tooltip="ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑÿ£ŸäÿßŸÖ">
                    <span>ÿπÿ±ÿ∂ ÿ®ÿßŸÇŸä ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</span>
                    <svg class="w-3 h-3 transition-transform duration-300 group-hover:translate-y-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // Gemini API Key (Inject at runtime)
        const apiKey = "AIzaSyC0EBG7-NrF1jfzzQiHNuDZ1tIffhB_H4I"; 

        // --- Global State ---
        let GLOBAL_DATA = null;
        let CURRENT_VIEW_INDEX = 0; 
        let SELECTED_HOUR_INDEX = -1;
        
        // Caching the current detail values for AI context
        let currentDetailValues = {};

        const ICON_BASE = 'https://cdn.jsdelivr.net/gh/basmilius/weather-icons/production/fill/all/';

        // --- Backgrounds ---
        const bgs = {
            clear: "url('https://images.unsplash.com/photo-1601297183305-6df142704ea2?q=80&w=2574&auto=format&fit=crop')",
            cloudy: "url('https://images.unsplash.com/photo-1534088568595-a066f410bcda?q=80&w=2851&auto=format&fit=crop')",
            rain: "url('https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?q=80&w=2574&auto=format&fit=crop')",
            snow: "url('https://images.unsplash.com/photo-1491002052546-bf38f186af56?q=80&w=2708&auto=format&fit=crop')",
            thunder: "url('https://images.unsplash.com/photo-1605727216801-e27ce1d0cc28?q=80&w=2671&auto=format&fit=crop')",
            fog: "url('https://images.unsplash.com/photo-1487621167305-5d248087c724?q=80&w=2664&auto=format&fit=crop')"
        };

        // --- Helper Functions ---
        function getIconSrc(code, isDay = 1) {
            const suffix = isDay ? 'day' : 'night';
            if (code === 0) return { src: `${ICON_BASE}clear-${suffix}.svg`, bg: bgs.clear };
            if (code <= 3) return { src: `${ICON_BASE}partly-cloudy-${suffix}.svg`, bg: bgs.cloudy };
            if (code <= 48) return { src: `${ICON_BASE}fog-${suffix}.svg`, bg: bgs.fog };
            if (code <= 67) return { src: `${ICON_BASE}rain.svg`, bg: bgs.rain };
            if (code <= 77) return { src: `${ICON_BASE}snow.svg`, bg: bgs.snow };
            if (code <= 82) return { src: `${ICON_BASE}rain.svg`, bg: bgs.rain };
            if (code >= 95) return { src: `${ICON_BASE}thunderstorm.svg`, bg: bgs.thunder };
            return { src: `${ICON_BASE}not-available.svg`, bg: bgs.clear };
        }

        function getWeatherDesc(code) {
            const codes = { 0:'ÿµÿßŸÅŸä',1:'ÿ∫ÿßÿ¶ŸÖ ŸÇŸÑŸäŸÑÿßŸã',2:'ÿ∫ÿßÿ¶ŸÖ ÿ¨ÿ≤ÿ¶ŸäÿßŸã',3:'ÿ∫ÿßÿ¶ŸÖ',45:'ÿ∂ÿ®ÿßÿ®',51:'ÿ±ÿ∞ÿßÿ∞',61:'ŸÖÿ∑ÿ± ÿÆŸÅŸäŸÅ',63:'ŸÖÿ∑ÿ±',65:'ŸÖÿ∑ÿ± ÿ∫ÿ≤Ÿäÿ±',71:'ÿ´ŸÑŸàÿ¨',95:'ÿ±ÿπÿØ' };
            return codes[code] || 'ŸÖÿ™ŸÇŸÑÿ®';
        }

        // --- INSIGHT LOGIC ---
        function getHumStatus(val) { return val < 30 ? 'ÿ¨ÿßŸÅ' : val <= 60 ? 'ŸÖÿ±Ÿäÿ≠' : val <= 80 ? 'ÿ±ÿ∑ÿ®' : 'ÿÆÿßŸÜŸÇ'; }
        function getWindStatus(val) { return val < 10 ? 'ŸáÿßÿØÿ¶ÿ©' : val <= 30 ? 'ŸÜÿ≥ŸäŸÖ' : val <= 50 ? 'ŸÜÿ¥ÿ∑ÿ©' : 'ÿπÿßÿµŸÅÿ©'; }
        function getUvStatus(val) { return val < 3 ? 'ÿ¢ŸÖŸÜ' : val <= 6 ? 'ŸÖÿ™Ÿàÿ≥ÿ∑' : val <= 8 ? 'ŸÖÿ±ÿ™ŸÅÿπ' : 'ÿÆÿ∑ÿ±'; }
        function getVisStatus(val) { return val > 10 ? 'ŸÖŸÖÿ™ÿßÿ≤ÿ©' : val > 5 ? 'ÿ¨ŸäÿØÿ©' : val > 2 ? 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©' : 'ÿ∂ÿ®ÿßÿ®Ÿäÿ©'; }
        function getPressStatus(val) { return val < 1000 ? 'ŸÖŸÜÿÆŸÅÿ∂' : val <= 1020 ? 'ŸÖÿ≥ÿ™ŸÇÿ±' : 'ŸÖÿ±ÿ™ŸÅÿπ'; }
        function getCloudStatus(val) { return val < 10 ? 'ÿ≥ŸÖÿßÿ° ÿµÿßŸÅŸäÿ©' : val < 50 ? 'ŸÖÿ™ŸÜÿßÿ´ÿ±ÿ©' : 'ŸÖŸÑÿ®ÿØÿ©'; }
        function getAppTempStatus(temp, appTemp) { const diff = appTemp - temp; return diff > 2 ? 'ÿ£ÿ≠ÿ± ŸÖŸÜ ÿßŸÑŸàÿßŸÇÿπ' : diff < -2 ? 'ÿ£ÿ®ÿ±ÿØ ŸÖŸÜ ÿßŸÑŸàÿßŸÇÿπ' : 'ŸÖÿ∑ÿßÿ®ŸÇ ŸÑŸÑŸàÿßŸÇÿπ'; }

        // --- AI TOOLTIP & TIP LOGIC ---
        
        // Tooltip Event Delegation
        const tooltipEl = document.getElementById('glass-tooltip');
        
        document.addEventListener('mouseover', (e) => {
            const target = e.target.closest('[data-tooltip]');
            if (target) {
                tooltipEl.textContent = target.getAttribute('data-tooltip');
                tooltipEl.classList.add('show');
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (tooltipEl.classList.contains('show')) {
                // Keep tooltip near cursor but prevent overflow
                const x = e.clientX + 15;
                const y = e.clientY + 15;
                tooltipEl.style.left = x + 'px';
                tooltipEl.style.top = y + 'px';
            }
        });

        document.addEventListener('mouseout', (e) => {
            const target = e.target.closest('[data-tooltip]');
            if (target) {
                tooltipEl.classList.remove('show');
            }
        });

        // Generate AI Tip Bar
        async function generateAiTip(temp, desc) {
            const tipTextEl = document.getElementById('ai-tip-text');
            
            // Quick random local tips first to show something immediately
            const localTips = [
                `ÿßŸÑÿ¨Ÿà ${temp}¬∞ÿå ŸÖŸÜÿßÿ≥ÿ® ÿ¨ÿØÿßŸã ŸÑŸÉŸàÿ® ÿ¥ÿßŸä! ‚òï`,
                `ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÇÿ≥ ${desc}ÿå ŸÑÿß ÿ™ŸÜÿ≥Ÿâ ÿßÿ®ÿ™ÿ≥ÿßŸÖÿ™ŸÉ! üòä`,
                `ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ© ${temp}¬∞ÿå ŸÉŸÜ ŸÖÿ≥ÿ™ÿπÿØÿßŸã ŸÑŸäŸàŸÖŸÉ! üí™`,
                `ÿßŸÑÿ∑ŸÇÿ≥ ${desc} ÿßŸÑŸäŸàŸÖÿå ÿßÿ≥ÿ™ŸÖÿ™ÿπ ÿ®ŸàŸÇÿ™ŸÉ! üåü`
            ];
            const randomTip = localTips[Math.floor(Math.random() * localTips.length)];
            tipTextEl.innerText = randomTip;

            // If API Key exists, fetch smarter tip
            if (apiKey && apiKey !== "") {
                const prompt = `ÿßŸÉÿ™ÿ® ŸÜÿµŸäÿ≠ÿ© ŸÇÿµŸäÿ±ÿ© ÿ¨ÿØÿßŸã ÿ¨ÿØÿßŸã (ÿ≥ÿ∑ÿ± Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑ÿå ÿ≠ÿØ ÿ£ŸÇÿµŸâ 10 ŸÉŸÑŸÖÿßÿ™) ŸàŸÖÿ±ÿ≠ÿ© ÿ®ÿßŸÑŸÑŸáÿ¨ÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ© ÿ£Ÿà ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿßŸÑŸÑÿ∑ŸäŸÅÿ© ŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸäŸàÿßÿ¨Ÿá ÿ∑ŸÇÿ≥ ÿØÿ±ÿ¨ÿ© ÿ≠ÿ±ÿßÿ±ÿ™Ÿá ${temp} Ÿàÿ≠ÿßŸÑÿ™Ÿá ${desc}.`;
                
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const aiTip = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if(aiTip) {
                        tipTextEl.innerText = aiTip.replace(/[\"\n]/g, '');
                    }
                } catch (e) { console.error("Tip Fetch Error", e); }
            }
        }

        // --- AI MODAL LOGIC (GEMINI) ---
        
        const detailMap = {
            'apparent_temp': { name: 'ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ÿ≥Ÿàÿ≥ÿ©', icon: 'thermometer.svg' },
            'humidity': { name: 'ÿßŸÑÿ±ÿ∑Ÿàÿ®ÿ©', icon: 'humidity.svg' },
            'wind': { name: 'ÿßŸÑÿ±Ÿäÿßÿ≠', icon: 'wind.svg' },
            'pressure': { name: 'ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑÿ¨ŸàŸä', icon: 'barometer.svg' },
            'clouds': { name: 'ÿßŸÑÿ∫ÿ∑ÿßÿ° ÿßŸÑÿ≥ÿ≠ÿßÿ®Ÿä', icon: 'overcast.svg' },
            'uv': { name: 'ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ£ÿ¥ÿπÿ© (UV)', icon: 'uv-index.svg' },
            'visibility': { name: 'ŸÖÿØŸâ ÿßŸÑÿ±ÿ§Ÿäÿ©', icon: 'mist.svg' }
        };

        async function openAiAnalysis(type) {
            const modal = document.getElementById('ai-modal');
            const modalContent = document.getElementById('ai-modal-content');
            const loader = document.getElementById('ai-loading-state');
            const result = document.getElementById('ai-result-state');
            const responseText = document.getElementById('ai-response-text');
            const iconImg = document.getElementById('ai-modal-icon');
            
            // Get Current Data
            const info = detailMap[type];
            const val = currentDetailValues[type]?.val || '--';
            const status = currentDetailValues[type]?.status || '';

            // Set Modal Info
            document.getElementById('ai-modal-title').innerText = `ÿ™ÿ≠ŸÑŸäŸÑ ${info.name}`;
            document.getElementById('ai-modal-value').innerText = `${val} (${status})`;
            iconImg.src = ICON_BASE + info.icon;
            document.getElementById('ai-modal-title').innerText = `ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ${info.name}...`;

            // Show Modal
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');

            // Reset States
            loader.classList.remove('hidden');
            result.classList.add('hidden');
            responseText.innerText = "";

            // --- GEMINI REQUEST ---
            const prompt = `ÿ£ŸÜÿ™ ÿÆÿ®Ÿäÿ± ÿ£ÿ±ÿµÿßÿØ ÿ¨ŸàŸäÿ©. ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÑŸÄ ${info.name} ŸáŸä ${val} ŸàÿßŸÑÿ≠ÿßŸÑÿ© "${status}". 
            ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ∞ŸÑŸÉÿå ÿ£ÿπÿ∑ŸÜŸä ŸÜÿµŸäÿ≠ÿ© ÿµÿ≠Ÿäÿ© ÿ£Ÿà ÿπŸÖŸÑŸäÿ© ŸÇÿµŸäÿ±ÿ© ŸàŸÖŸÅŸäÿØÿ© ÿ¨ÿØÿßŸã ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ŸÑÿß ÿ™ÿ≤ŸäÿØ ÿπŸÜ 30 ŸÉŸÑŸÖÿ©).`;

            let aiReply = "";

            try {
                // Retry logic helper
                const fetchGemini = async (retries = 3, delay = 1000) => {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }]
                            })
                        });

                        if (!response.ok) throw new Error(response.statusText);
                        const data = await response.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text;
                    } catch (err) {
                        if (retries > 0) {
                            await new Promise(r => setTimeout(r, delay));
                            return fetchGemini(retries - 1, delay * 2);
                        } else {
                            throw err;
                        }
                    }
                };
                
                aiReply = await fetchGemini();
                if (!aiReply) throw new Error("No response");

            } catch (error) {
                console.error(error);
                const demos = {
                    'humidity': "ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ±ÿ∑Ÿàÿ®ÿ© Ÿáÿ∞Ÿá ŸÇÿØ ÿ™ÿ≥ÿ®ÿ® ÿßŸÑÿ™ÿπÿ±ŸÇ ÿßŸÑÿ≤ÿßÿ¶ÿØ. ŸäŸÅÿ∂ŸÑ ÿßÿ±ÿ™ÿØÿßÿ° ŸÖŸÑÿßÿ®ÿ≥ ŸÇÿ∑ŸÜŸäÿ© ÿÆŸÅŸäŸÅÿ© Ÿàÿ¥ÿ±ÿ® ÿßŸÑŸÉÿ´Ÿäÿ± ŸÖŸÜ ÿßŸÑÿ≥Ÿàÿßÿ¶ŸÑ ŸÑÿ™ÿπŸàŸäÿ∂ ÿßŸÑÿ¨ŸÅÿßŸÅ.",
                    'uv': "ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ£ÿ¥ÿπÿ© Ÿäÿ™ÿ∑ŸÑÿ® ÿßŸÑÿ≠ÿ∞ÿ±. ŸäŸèŸÜÿµÿ≠ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸàÿßŸÇŸä ÿ¥ŸÖÿ≥ Ÿàÿßÿ±ÿ™ÿØÿßÿ° ŸÇÿ®ÿπÿ© ÿπŸÜÿØ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÑŸÅÿ™ÿ±ÿßÿ™ ÿ∑ŸàŸäŸÑÿ©.",
                    'wind': "ÿßŸÑÿ±Ÿäÿßÿ≠ ŸÜÿ¥ÿ∑ÿ© ŸÇŸÑŸäŸÑÿßŸã. ŸÇÿØ ŸäŸÉŸàŸÜ ÿßŸÑÿ¨Ÿà ŸÑÿ∑ŸäŸÅÿßŸã ŸÑŸÉŸÜ ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ£ŸÖÿßŸÉŸÜ ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ© ÿ¨ÿØÿßŸã ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ÿ™ÿπÿßŸÜŸä ŸÖŸÜ ÿßŸÑÿ≠ÿ≥ÿßÿ≥Ÿäÿ©.",
                    'default': "ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ®ÿØŸà ÿ∑ÿ®ŸäÿπŸäÿ©ÿå ŸÑŸÉŸÜ ÿØÿßÿ¶ŸÖÿßŸã ŸÉŸÜ ŸÖÿ≥ÿ™ÿπÿØÿßŸã ŸÑÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ∑ŸÇÿ≥ Ÿàÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ ÿ™ÿ±ÿ∑Ÿäÿ® ÿ¨ÿ≥ŸÖŸÉ."
                };
                aiReply = demos[type] || demos['default'];
                aiReply += "\n\n(ÿ™ÿπÿ∞ÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ Geminiÿå Ÿáÿ∞Ÿá ŸÜÿµŸäÿ≠ÿ© ÿπÿßŸÖÿ©)";
            }

            // Show Result
            loader.classList.add('hidden');
            result.classList.remove('hidden');
            document.getElementById('ai-modal-title').innerText = `ÿ™ÿ≠ŸÑŸäŸÑ ${info.name}`; 
            
            // Typewriter effect
            let i = 0;
            const typeWriter = () => {
                if (i < aiReply.length) {
                    responseText.innerHTML += aiReply.charAt(i);
                    i++;
                    setTimeout(typeWriter, 15); 
                }
            };
            typeWriter();
        }

        function closeAiModal() {
            const modal = document.getElementById('ai-modal');
            const modalContent = document.getElementById('ai-modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // --- Core Application Logic ---

        function updateClock() {
            if(CURRENT_VIEW_INDEX !== 0 || SELECTED_HOUR_INDEX !== -1) return; 
            const now = new Date();
            document.getElementById('main-title').innerText = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('sub-title').innerText = now.toLocaleDateString('ar-EG', { weekday: 'long', day: 'numeric', month: 'long' });
        }
        setInterval(updateClock, 1000);

        function initDragScroll() {
            const slider = document.getElementById('hourly-container');
            let isDown = false;
            let startX;
            let scrollLeft;

            slider.addEventListener('mousedown', (e) => {
                isDown = true;
                slider.classList.add('cursor-grabbing');
                slider.classList.remove('cursor-grab');
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });

            slider.addEventListener('mouseleave', () => {
                isDown = false;
                slider.classList.remove('cursor-grabbing');
                slider.classList.add('cursor-grab');
            });

            slider.addEventListener('mouseup', () => {
                isDown = false;
                slider.classList.remove('cursor-grabbing');
                slider.classList.add('cursor-grab');
            });

            slider.addEventListener('mousemove', (e) => {
                if(!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2;
                slider.scrollLeft = scrollLeft - walk;
            });
        }

        function getLocation() {
            const loading = document.getElementById('loading');
            const content = document.getElementById('weather-content');
            loading.style.display = 'flex'; loading.style.opacity = '1'; content.style.opacity = '0';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(fetchData, () => {
                    document.getElementById('loading-text').innerText = "ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ŸÅÿπŸäŸÑ GPS";
                    alert("Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸàŸÇÿπ");
                });
            } else { alert("Not Supported"); }
        }

        async function fetchData(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            try {
                const locRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=ar`);
                const locData = await locRes.json();
                let locationString = locData.city || "ŸÖŸàŸÇÿπŸÉ";
                if (locData.locality && locData.locality !== locData.city) locationString = `${locData.locality}ÿå ${locData.city}`;
                else if (locData.principalSubdivision) locationString = `${locData.city}ÿå ${locData.principalSubdivision}`;
                
                document.getElementById('location-text').innerText = locationString;

                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relativehumidity_2m,apparent_temperature,uv_index,visibility,surface_pressure,cloudcover,windspeed_10m,weathercode,is_day&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`;
                const res = await fetch(url);
                GLOBAL_DATA = await res.json();

                renderView(0); 
                renderForecastList();
                initDragScroll();

                const loader = document.getElementById('loading');
                const content = document.getElementById('weather-content');
                loader.style.opacity = '0';
                setTimeout(() => { loader.style.display = 'none'; content.style.opacity = '1'; }, 500);

            } catch (e) { console.error(e); }
        }

        function selectHour(hourlyIndex) {
            SELECTED_HOUR_INDEX = hourlyIndex;
            renderHourlyStrip();
            updateMainDisplay(hourlyIndex);
        }

        function updateMainDisplay(hIdx) {
            const hourly = GLOBAL_DATA.hourly;
            
            const hTemp = Math.round(hourly.temperature_2m[hIdx]);
            const hCode = hourly.weathercode[hIdx];
            const hIsDay = hourly.is_day[hIdx];
            const hTime = new Date(hourly.time[hIdx]);

            const iconInfo = getIconSrc(hCode, hIsDay);
            document.getElementById('dynamic-bg').style.backgroundImage = iconInfo.bg;
            document.getElementById('main-icon-img').src = iconInfo.src;
            
            document.getElementById('current-temp').innerText = hTemp + '¬∞';
            document.getElementById('weather-desc').innerText = getWeatherDesc(hCode);
            
            if (SELECTED_HOUR_INDEX !== -1) {
                document.getElementById('main-title').innerText = hTime.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
                document.getElementById('sub-title').innerText = hTime.toLocaleDateString('ar-EG', {weekday: 'long', day: 'numeric'});
                
                const indicator = document.getElementById('selected-time-indicator');
                indicator.style.opacity = '1';
                indicator.innerText = `ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿßÿπÿ©: ${hTime.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'})}`;
            } else {
                document.getElementById('selected-time-indicator').style.opacity = '0';
            }

            // Update AI Tip when display changes
            generateAiTip(hTemp, getWeatherDesc(hCode));

            // --- Update Grid & Store Values for AI ---
            const updateMetric = (key, idPrefix, val, status) => {
                document.getElementById(idPrefix + '-val').innerText = val;
                document.getElementById(idPrefix + '-status').innerText = status;
                currentDetailValues[key] = { val, status };
            };

            const appTemp = hourly.apparent_temperature[hIdx];
            const hum = hourly.relativehumidity_2m[hIdx];
            const wind = hourly.windspeed_10m[hIdx];
            const press = Math.round(hourly.surface_pressure[hIdx]);
            const clouds = hourly.cloudcover[hIdx];
            const uv = hourly.uv_index[hIdx];
            const visKm = (hourly.visibility[hIdx] / 1000).toFixed(1);

            updateMetric('apparent_temp', 'app-temp', Math.round(appTemp) + '¬∞', getAppTempStatus(hTemp, appTemp));
            updateMetric('humidity', 'humidity', hum + '%', getHumStatus(hum));
            updateMetric('wind', 'wind', wind + ' ŸÉŸÖ', getWindStatus(wind));
            updateMetric('pressure', 'press', press + ' hPa', getPressStatus(press));
            updateMetric('clouds', 'cloud', clouds + '%', getCloudStatus(clouds));
            updateMetric('uv', 'uv', uv, getUvStatus(uv));
            updateMetric('visibility', 'vis', visKm + ' ŸÉŸÖ', getVisStatus(visKm));
        }

        function renderView(dayIndex) {
            CURRENT_VIEW_INDEX = dayIndex;
            SELECTED_HOUR_INDEX = -1; 
            
            const data = GLOBAL_DATA;
            const daily = data.daily;
            const hourly = data.hourly;
            const current = data.current_weather;

            renderForecastList();

            let hIdx; 

            if (dayIndex === 0) {
                hIdx = new Date().getHours();
                document.getElementById('view-mode').innerText = "ŸÖÿ®ÿßÿ¥ÿ±";
                document.getElementById('hourly-title').innerText = "ÿÆŸÑÿßŸÑ ÿßŸÑŸäŸàŸÖ";
                updateClock();
                
                updateMainDisplay(hIdx);
                document.getElementById('current-temp').innerText = Math.round(current.temperature) + '¬∞';
                document.getElementById('selected-time-indicator').style.opacity = '0';
            } else {
                hIdx = (dayIndex * 24) + 13; 
                const d = new Date(daily.time[dayIndex]);
                document.getElementById('view-mode').innerText = "ÿ™ŸàŸÇÿπÿßÿ™ ŸÖÿ≥ÿ™ŸÇÿ®ŸÑŸäÿ©";
                document.getElementById('main-title').innerText = d.toLocaleDateString('ar-EG', { weekday: 'long' });
                document.getElementById('sub-title').innerText = d.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('hourly-title').innerText = "ÿ™ŸàŸÇÿπÿßÿ™ " + d.toLocaleDateString('ar-EG', { weekday: 'long' });
                document.getElementById('selected-time-indicator').style.opacity = '0';
                updateMainDisplay(hIdx);
            }
            
            document.getElementById('min-temp-display').innerText = Math.round(daily.temperature_2m_min[dayIndex]) + '¬∞';
            
            renderHourlyStrip();

            document.getElementById('sunrise-val').innerText = new Date(daily.sunrise[dayIndex]).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('sunset-val').innerText = new Date(daily.sunset[dayIndex]).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});

            const hero = document.getElementById('hero-section');
            hero.classList.remove('anim-fade');
            void hero.offsetWidth;
            hero.classList.add('anim-fade');
        }

        function renderHourlyStrip() {
            const hourlyContainer = document.getElementById('hourly-container');
            const dayIndex = CURRENT_VIEW_INDEX;
            const hourly = GLOBAL_DATA.hourly;
            
            hourlyContainer.innerHTML = '';
            
            let startHour = (dayIndex === 0) ? new Date().getHours() : (dayIndex * 24);
            const currentRealHour = new Date().getHours();
            
            for(let i = startHour; i < startHour + 24; i++) {
                if(i >= hourly.time.length) break;

                const hTime = new Date(hourly.time[i]);
                const hTemp = Math.round(hourly.temperature_2m[i]);
                const hCode = hourly.weathercode[i];
                const hIsDay = hourly.is_day[i]; 
                
                let timeString = hTime.toLocaleTimeString('ar-EG', {hour: 'numeric'});
                let isNow = false;

                if (i === currentRealHour && dayIndex === 0) {
                    timeString = "ÿßŸÑÿ¢ŸÜ";
                    isNow = true;
                }

                const hIcon = getIconSrc(hCode, hIsDay).src;

                let activeClass = '';
                if (SELECTED_HOUR_INDEX !== -1) {
                    if (SELECTED_HOUR_INDEX === i) activeClass = 'active-state';
                } else if (isNow) {
                     activeClass = 'active-state';
                }

                const labelClass = isNow ? 'now-badge text-white font-bold' : 'text-blue-200 mb-2 font-medium';
                
                // Added Tooltip Data
                const tooltipText = `ÿßŸÑÿ≥ÿßÿπÿ© ${timeString} - ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ© ${hTemp}¬∞`;

                const hourHTML = `
                <div onclick="selectHour(${i})" data-tooltip="${tooltipText}" class="glass-item min-w-[70px] flex flex-col items-center justify-center p-3 rounded-2xl border border-white/5 bg-white/5 backdrop-blur-sm hover:bg-white/10 transition-transform select-none cursor-pointer ${activeClass}">
                    <span class="text-[11px] whitespace-nowrap ${labelClass}">${timeString}</span>
                    <img src="${hIcon}" class="w-8 h-8 mb-2 drop-shadow-md object-contain select-none" draggable="false">
                    <span class="text-base font-bold text-white">${hTemp}¬∞</span>
                </div>
                `;
                hourlyContainer.innerHTML += hourHTML;
            }
        }

        function renderForecastList() {
            const daily = GLOBAL_DATA.daily;
            const list = document.getElementById('forecast-list');
            const more = document.getElementById('more-days');
            list.innerHTML = ''; more.innerHTML = '';

            for(let i = 0; i < daily.time.length; i++) {
                const date = new Date(daily.time[i]);
                const dayName = i === 0 ? 'ÿßŸÑŸäŸàŸÖ' : date.toLocaleDateString('ar-EG', { weekday: 'long' });
                const max = Math.round(daily.temperature_2m_max[i]);
                const min = Math.round(daily.temperature_2m_min[i]);
                const fIcon = getIconSrc(daily.weathercode[i], 1).src;
                
                const activeClass = (i === CURRENT_VIEW_INDEX) ? 'active-state' : '';
                
                // Added Tooltip Data
                const tooltipText = `${dayName}: ÿßŸÑÿπÿ∏ŸÖŸâ ${max}¬∞ / ÿßŸÑÿµÿ∫ÿ±Ÿâ ${min}¬∞`;

                const itemHTML = `
                <div onclick="renderView(${i})" data-tooltip="${tooltipText}" class="glass-item p-3 rounded-xl flex items-center justify-between cursor-pointer anim-fade ${activeClass}" style="animation-delay: ${i * 0.05}s">
                    <div class="flex items-center gap-3 w-1/3">
                        <img src="${fIcon}" class="w-9 h-9 drop-shadow-sm">
                        <span class="font-medium text-sm text-gray-100">${dayName}</span>
                    </div>
                    <div class="flex items-center justify-end gap-4 w-2/3 ml-auto">
                        <span class="font-bold text-base text-white">${max}¬∞</span>
                        <span class="text-white/40 text-xs font-light">${min}¬∞</span>
                    </div>
                </div>`;

                if(i < 4) list.innerHTML += itemHTML;
                else more.innerHTML += itemHTML;
            }
        }

        const btn = document.getElementById('toggle-btn');
        const moreDiv = document.getElementById('more-days');
        let expanded = false;
        btn.addEventListener('click', () => {
            expanded = !expanded;
            if(expanded) {
                moreDiv.classList.add('open');
                btn.querySelector('span').innerText = 'ÿπÿ±ÿ∂ ÿ£ŸÇŸÑ';
                btn.querySelector('svg').style.transform = 'rotate(180deg)';
            } else {
                moreDiv.classList.remove('open');
                btn.querySelector('span').innerText = 'ÿπÿ±ÿ∂ ÿ®ÿßŸÇŸä ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ';
                btn.querySelector('svg').style.transform = 'rotate(0deg)';
            }
        });

        getLocation();
    </script>
</body>
</html>
